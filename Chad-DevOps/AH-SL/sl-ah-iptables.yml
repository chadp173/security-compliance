  tasks:
    - name: Setting up IPTABLE rules
      shell: |
          ## Set default policy and flush current rules
          iptables -P INPUT ACCEPT
          iptables -P FORWARD ACCEPT
          iptables -P OUTPUT ACCEPT
          iptables -F

          # INPUT CHAIN POLICY
          iptables -A INPUT -i lo -j ACCEPT
          iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

          iptables -A INPUT -p icmp -s 9.0.0.0/8 -j ACCEPT
          iptables -A INPUT -p icmp -s 10.0.0.0/8 -j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.131.0/24 -j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.194.0/24 -j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.195.0/24 -j ACCEPT
          iptables -A INPUT -p tcp -s 9.204.146.30.151 --dport 22 -j ACCEPT

          iptables -A INPUT -p tcp -s y03lcacchub001.maint.ahe.boulder.ibm.com -j ACCEPT
          iptables -A INPUT -p tcp -s b03lcacchub002.maint.ahe.boulder.ibm.com -j ACCEPT
          iptables -A INPUT -p tcp -s y01lcacchub001.maint.ahe.pok.ibm.com -j ACCEPT
          iptables -A INPUT -p tcp -s 9.0.0.0/8  --match multiport --dports 22,80:99,443,5000,5001,8080:8099,8350:8360,9000:9020,35357,35358,50001 -j ACCEPT

          iptables -A INPUT -p tcp -j --match multiport --dport sun,sr,https -j ACCEPT
          iptables -A INPUT -p tcp -s 172-0-0-0.lightspeed.brhmal.sbcglobal.net/8 -j ACCEPT

          # mysql - 3306
          iptables -A INPUT -p tcp -s 9.207.131.0/24 --dport 50000 -j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.194.0/24 --dport 50000 -j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.195.0/24 --dport 50000 -j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.131.0/24 --dport mysql -j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.194.0/24 --dport mysql -j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.195.0/24 --dport mysql -j ACCEPT

          # SMPT - 587
          iptables -A INPUT -p tcp -s 9.207.131.0/24 --dport smtp -j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.194.0/24 --dport smtp-j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.195.0/24 --dport smtp-j ACCEPT

          # Docker API
          iptables -A INPUT -p tcp -s 9.207.131.0/24 --match multiport --dports 2375:2376 -j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.194.0/24 --match multiport --dports 2375:2376 -j ACCEPT
          iptables -A INPUT -p tcp -s 9.207.195.0/24 --match multiport --dports 2375:2376 -j ACCEPT

           # fmtp - 8500
           iptables -A INPUT -p tcp -s 9.207.131.0/24 --dport fmtp -j ACCEPT
           iptables -A INPUT -p tcp -s 9.207.194.0/24 --dport fmtp -j ACCEPT
           iptables -A INPUT -p tcp -s 9.207.195.0/24 --dport fmtp -j ACCEPT

           # tmi - 8300
           iptables -A INPUT -p tcp -s 9.207.131.0/24 --dport tmi -j ACCEPT
           iptables -A INPUT -p tcp -s 9.207.194.0/24 --dport tmi -j ACCEPT
           iptables -A INPUT -p tcp -s 9.207.195.0/24 --dport tmi -j ACCEPT

           # trivnet1
           iptables -A INPUT -p tcp -s 9.207.131.0/24 --dport trivnet1 -j ACCEPT
           iptables -A INPUT -p tcp -s 9.207.194.0/24 --dport trivnet1 -j ACCEPT
           iptables -A INPUT -p tcp -s 9.207.195.0/24 --dport trivnet1 -j ACCEPT

           # tmi:8302
           iptables -A INPUT -p tcp -s  9.207.131.0/24 --match multiport --dport tmi,8302 -j ACCEPT
           iptables -A INPUT -p tcp -s 9.207.194.0/24 --match multiport --dport tmi,8302 -j ACCEPT
           iptables -A INPUT -p tcp -s 9.207.195.0/24 --match multiport --dport tmi,8302 -j ACCEPT

           # rbsystem
           iptables -A INPUT -p tcp -s 9.207.131.0/24 --dport rbsystem -j ACCEPT
           iptables -A INPUT -p tcp -s 9.207.194.0/24 --dport rbsystem -j ACCEPT
           iptables -A INPUT -p tcp -s 9.45.203.0/24  --dport rbsystem -j ACCEPT
           iptables -A INPUT -p tcp -s 9.207.195.0/24 --dport rbsystem -j ACCEPT

           # Bootps/pc
           iptables -A INPUT -p udp -s 9.207.131.0/24 --dport bootps -j ACCEPT
           iptables -A INPUT -p tcp -s 9.207.195.0/24 --dport bootpc -j ACCEPT

           iptables -A INPUT -s 9.63.39.57/32 -p tcp -j ACCEPT
           iptables -A INPUT -s 9.56.126.11/32 -p tcp -j ACCEPT
           iptables -A INPUT -j LOGGING
           iptables -A FORWARD -i docker0 -o ens192 -j ACCEPT

           # AccessHub
           # ec2-34-250-81-152.eu-west-1.compute.amazonaws.com
           # ec2-34-249-212-128.eu-west-1.compute.amazonaws.com
           iptables -A INPUT -p tcp -s 34.249.212.128 --dport 22 -j ACCEPT
           iptables -A INPUT -p tcp -s 34.250.81.152 --dport 22-j ACCEPT

           # FORWARD CHAIN POLICY
           iptables -A FORWARD -i docker0 -o ens192 -j ACCEPT
           iptables -A FORWARD -i ens192 -o docker0 -m state  --state RELATED,ESTABLISHED -j ACCEPT

           # OUTPUT CHAIN POLICY
           iptables -A OUTPUT -o lo -j ACCEPT
           iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
           iptables -A OUTPUT -m state --state NEW -j ACCEPT
           iptables -A OUTPUT -o docker0 -j ACCEPT

           # LOGGING CHAIN POLICY
           iptables -A LOGGING -m limit --limit 2/min -j LOG --log-prefix "IPTables-Dropped: " --log-level 5
           iptables -A LOGGING -j DROP

           # LOGNDROP CHAIN POLICY
           iptables -A INPUT -j LOGNDROP

           # LOGNEW CHAIN POLICY
           iptables -N LOGNEW
           iptables -A LOGNEW -j LOG  --log-prefix "IPT_CONN_NEW:" --log-level 4
           iptables -A LOGNEW -j ACCEPT

          # update configuration file
          sed -i 's/IPTABLES_SAVE_ON_RESTART="no"/IPTABLES_SAVE_ON_RESTART="yes"/g' /etc/sysconfig/iptables-config
          sed -i 's/IPTABLES_SAVE_ON_STOP="no"/IPTABLES_SAVE_ON_STOP="yes"/g' /etc/sysconfig/iptables-config

          # save iptable rules
          iptables-save > /etc/iptables.rules
          iptables-save
      args:
        executable: /bin/bash
      when: inventory_hostname in groups['softlayer-all']
